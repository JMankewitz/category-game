<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Master - Category Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            text-align: center;
        }

        .room-code {
            font-size: 3rem;
            font-weight: 700;
            color: #667eea;
            margin: 1rem 0;
            letter-spacing: 0.2em;
        }

        .status {
            padding: 1rem 2rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .players {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .player {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .button {
            background: #667eea;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #setup {
            display: block;
        }

        #waiting {
            display: none;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .game-controls {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        /* Timer status display for GM */
        .timer-status {
            background: #e8f4fd;
            border: 2px solid #667eea;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timer-info {
            flex: 1;
        }

        .timer-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .timer-details {
            color: #666;
            font-size: 0.9rem;
        }

        .timer-display-gm {
            text-align: center;
            min-width: 120px;
        }

        .timer-countdown-gm {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            font-family: 'Courier New', monospace;
            margin-bottom: 0.3rem;
        }

        .timer-countdown-gm.warning {
            color: #ff9800;
        }

        .timer-countdown-gm.critical {
            color: #f44336;
            animation: gmTimerPulse 1s infinite;
        }

        .timer-phase-gm {
            font-size: 0.8rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @keyframes gmTimerPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .timer-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .timer-control-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .timer-control-btn:hover {
            background: #5a6268;
        }

        .timer-control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .early-completion-indicator {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* Auto-mode indicator */
        .auto-mode-indicator {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            text-align: center;
        }

        .auto-mode-indicator::before {
            content: "ðŸ¤– ";
        }

        /* Hide timer when not active */
        .timer-status.hidden {
            display: none;
        }

        .phase-display {
            background: #e8f4fd;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
            color: #333;
        }

        .category-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .vote-status {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .player-vote-status {
            background: #f8f9ff;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            text-align: center;
        }

        .player-vote-status.submitted {
            background: #e8f5e8;
            color: #2d5a2d;
        }

        .player-vote-status.waiting {
            background: #fff3cd;
            color: #856404;
        }

        .display-preview {
            background: #f8f9ff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .button.secondary {
            background: #6c757d;
        }

        .button.secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Phase -->
        <div id="setup">
            <div class="header">
                <h1>ðŸŽ® Game Master</h1>
                <p>Create a room to start your category game</p>
                <button id="createRoomBtn" class="button">Create Room</button>
            </div>
            
            <div class="loading hidden">
                <p>Setting up your room...</p>
            </div>
        </div>

        <!-- Waiting for Players Phase -->
        <div id="waiting">
            <div class="header">
                <h1>Room Created!</h1>
                <p>Players can join with this code:</p>
                <div class="room-code" id="roomCode"></div>
                <p>Share this code with your players</p>
            </div>

            <div class="status">
                <h3>Game Status</h3>
                <div class="phase-display" id="currentPhase">Waiting for players to join...</div>
                <button id="startGameBtn" class="button" disabled>Start Game (Need at least 2 players)</button>
            </div>

            <div class="auto-mode-indicator">
                Autonomous Mode Active - Game will advance automatically
            </div>

            <div class="timer-status hidden" id="gmTimerStatus">
                <div class="timer-info">
                    <div class="timer-title" id="gmTimerTitle">Current Phase Timer</div>
                    <div class="timer-details" id="gmTimerDetails">Players are submitting exemplars</div>
                    <div class="early-completion-indicator hidden" id="earlyCompletionIndicator">
                        All players completed early! Advancing soon...
                    </div>
                </div>
                
                <div class="timer-display-gm">
                    <div class="timer-countdown-gm" id="gmTimerCountdown">2:00</div>
                    <div class="timer-phase-gm" id="gmTimerPhase">SUBMISSION</div>
                </div>
                
                <div class="timer-controls">
                    <button class="timer-control-btn" id="skipPhaseBtn" title="Skip to next phase">
                        Skip Phase
                    </button>
                    <button class="timer-control-btn" id="addTimeBtn" title="Add 30 seconds" disabled>
                        +30s
                    </button>
                </div>
            </div>

            <div class="game-controls hidden" id="gameControls">
                <h3>Game Controls</h3>
                
                <div id="categorySection" class="hidden">
                    <label for="categoryInput">Set Category for Round <span id="roundNumber">1</span>:</label>
                    <input type="text" id="categoryInput" class="category-input" placeholder="e.g., 'furniture', 'things that are red'">
                    <button id="setCategoryBtn" class="button">Set Category & Start Submissions</button>
                </div>

                <div id="submissionSection" class="hidden">
                    <p>Players are submitting exemplars for: <strong id="currentCategory"></strong></p>
                    <div class="vote-status" id="submissionStatus"></div>
                    <button id="startVotingBtn" class="button">Start Voting Phase</button>
                </div>

                <div id="votingSection" class="hidden">
                    <p>Players are voting on all exemplars</p>
                    <div class="vote-status" id="votingStatus"></div>
                    <button id="showResultsBtn" class="button">Show Results</button>
                </div>
                
                <div id="resultsSection" class="hidden">
                    <p>Results are displaying automatically on the main screen.</p>
                    <div id="finalControls" class="hidden">
                        <p>Round complete!</p>
                        <button id="nextRoundBtn" class="button">Next Round</button>
                        <button id="endGameBtn" class="button secondary">End Game</button>
                    </div>
                </div>

                <div class="display-preview">
                    <h4>Display Preview</h4>
                    <p id="displayPreview">Players will see the main display on the projector</p>
                </div>
            </div>

            <div class="players">
                <h3>Players (<span id="playerCount">0</span>)</h3>
                <div id="playerList" class="player-list">
                    <p class="loading">No players yet...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let roomCode = null;

        // DOM elements
        const setupDiv = document.getElementById('setup');
        const waitingDiv = document.getElementById('waiting');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const startGameBtn = document.getElementById('startGameBtn');
        const roomCodeDisplay = document.getElementById('roomCode');
        const playerCountDisplay = document.getElementById('playerCount');
        const playerListDiv = document.getElementById('playerList');
        const currentPhaseDisplay = document.getElementById('currentPhase');
        const gameControlsDiv = document.getElementById('gameControls');
        
        // Game control elements
        const categorySection = document.getElementById('categorySection');
        const submissionSection = document.getElementById('submissionSection');
        const votingSection = document.getElementById('votingSection');
        const resultsSection = document.getElementById('resultsSection');
        const categoryInput = document.getElementById('categoryInput');
        const setCategoryBtn = document.getElementById('setCategoryBtn');
        const startVotingBtn = document.getElementById('startVotingBtn');
        const showResultsBtn = document.getElementById('showResultsBtn');
        const nextRoundBtn = document.getElementById('nextRoundBtn');
        const endGameBtn = document.getElementById('endGameBtn');
        const roundNumber = document.getElementById('roundNumber');
        const currentCategory = document.getElementById('currentCategory');
        const submissionStatus = document.getElementById('submissionStatus');
        const votingStatus = document.getElementById('votingStatus');
        const displayPreview = document.getElementById('displayPreview');

        const resultProgress = document.getElementById('resultProgress');
        const currentResultInfo = document.getElementById('currentResultInfo');

        // Timer-related DOM elements for GM
        const gmTimerStatus = document.getElementById('gmTimerStatus');
        const gmTimerTitle = document.getElementById('gmTimerTitle');
        const gmTimerDetails = document.getElementById('gmTimerDetails');
        const gmTimerCountdown = document.getElementById('gmTimerCountdown');
        const gmTimerPhase = document.getElementById('gmTimerPhase');
        const earlyCompletionIndicator = document.getElementById('earlyCompletionIndicator');
        const skipPhaseBtn = document.getElementById('skipPhaseBtn');
        const addTimeBtn = document.getElementById('addTimeBtn');

        let gmTimerState = {
            remaining: 0,
            total: 0,
            phase: '',
            isActive: false,
            canSkip: false
        };

        // Create room
        createRoomBtn.addEventListener('click', () => {
            createRoomBtn.disabled = true;
            createRoomBtn.textContent = 'Creating...';
            socket.emit('create-room');
        });

        // Start game
        startGameBtn.addEventListener('click', () => {
            socket.emit('start-game');
        });

        // Set category
        setCategoryBtn.addEventListener('click', () => {
            const category = categoryInput.value.trim();
            if (!category) {
                alert('Please enter a category');
                return;
            }
            socket.emit('set-category', { category });
        });

        // Start voting
        startVotingBtn.addEventListener('click', () => {
            socket.emit('start-voting');
        });

        // Show results
        showResultsBtn.addEventListener('click', () => {
            socket.emit('show-results');
        });

        // Next round
        nextRoundBtn.addEventListener('click', () => {
            socket.emit('next-round');
        });

        // End game
        endGameBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to end the game?')) {
                socket.emit('end-game');
            }
        });

        // Socket events
        socket.on('room-created', (data) => {
            roomCode = data.roomCode;
            roomCodeDisplay.textContent = roomCode;
            setupDiv.style.display = 'none';
            waitingDiv.style.display = 'block';
            console.log('Room created:', roomCode);
        });

        socket.on('room-update', (data) => {
            updatePlayerList(data.players);
            updatePlayerCount(data.playerCount);
            
            // Enable start button if we have at least 2 players
            if (data.playerCount >= 2) {
                startGameBtn.disabled = false;
                startGameBtn.textContent = 'Start Game';
            } else {
                startGameBtn.disabled = true;
                startGameBtn.textContent = 'Start Game (Need at least 2 players)';
            }
        });

        // Handle timer updates
        socket.on('timer-update', (data) => {
            updateGMTimer(data.remaining, data.phase);
        });

        socket.on('game-started', (data) => {
            console.log('Game started:', data);
            currentPhaseDisplay.textContent = 'Game Active - Set first category';
            gameControlsDiv.classList.remove('hidden');
            categorySection.classList.remove('hidden');
            startGameBtn.style.display = 'none';
            displayPreview.textContent = 'Display shows: Waiting for first category';
        });

        socket.on('game-state-update', (data) => {
            updateGamePhase(data.gameState, data);
        });

        // Helper functions
        function updatePlayerCount(count) {
            playerCountDisplay.textContent = count;
        }


        function updateGMTimer(remaining, phase) {
            gmTimerState.remaining = remaining;
            gmTimerState.phase = phase;
            gmTimerState.isActive = remaining > 0;
            
            if (!gmTimerState.isActive) {
                gmTimerStatus.classList.add('hidden');
                return;
            }
            
            // Show timer
            gmTimerStatus.classList.remove('hidden');
            
            // Initialize total on first update of phase
            if (gmTimerState.total === 0 || gmTimerState.phase !== phase) {
                gmTimerState.total = remaining;
                gmTimerState.phase = phase;
                earlyCompletionIndicator.classList.add('hidden');
            }
            
            // Update countdown display
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            gmTimerCountdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update phase information
            const phaseInfo = {
                'submission': {
                    title: 'Submission Phase',
                    details: 'Players are submitting exemplars for the category',
                    phase: 'SUBMISSION'
                },
                'voting': {
                    title: 'Voting Phase', 
                    details: 'Players are voting on all submitted exemplars',
                    phase: 'VOTING'
                },
                'results': {
                    title: 'Results Phase',
                    details: 'Displaying results automatically',
                    phase: 'RESULTS'
                }
            };
            
            const info = phaseInfo[phase] || { title: 'Active Phase', details: 'Phase in progress', phase: 'ACTIVE' };
            gmTimerTitle.textContent = info.title;
            gmTimerDetails.textContent = info.details;
            gmTimerPhase.textContent = info.phase;
            
            // Apply warning styles
            const percentRemaining = (remaining / gmTimerState.total) * 100;
            
            gmTimerCountdown.classList.remove('warning', 'critical');
            
            if (percentRemaining <= 10) {
                gmTimerCountdown.classList.add('critical');
            } else if (percentRemaining <= 25) {
                gmTimerCountdown.classList.add('warning');
            }
            
            // Enable skip button during submission and voting phases
            gmTimerState.canSkip = (phase === 'submission' || phase === 'voting');
            skipPhaseBtn.disabled = !gmTimerState.canSkip;
        }

        // Function to show early completion state
        function showGMEarlyCompletion() {
            earlyCompletionIndicator.classList.remove('hidden');
        }

        // Reset GM timer
        function resetGMTimer() {
            gmTimerState = {
                remaining: 0,
                total: 0,
                phase: '',
                isActive: false,
                canSkip: false
            };
            gmTimerStatus.classList.add('hidden');
            earlyCompletionIndicator.classList.add('hidden');
        }

        // Skip phase button handler
        skipPhaseBtn.addEventListener('click', () => {
            if (!gmTimerState.canSkip) return;
            
            if (confirm(`Skip the current ${gmTimerState.phase} phase and advance immediately?`)) {
                // Emit skip event to server
                socket.emit('skip-phase');
            }
        });

        // Add time button handler (for future extension)
        addTimeBtn.addEventListener('click', () => {
            socket.emit('add-time', { seconds: 30 });
        });

        // Handle early completion notifications
        socket.on('early-completion', (data) => {
            showGMEarlyCompletion();
            
            // Update details to show completion status
            const completionTexts = {
                'submission': `All ${data.totalPlayers} players have submitted! Advancing in ${data.delaySeconds} seconds...`,
                'voting': `All ${data.totalPlayers} players have voted! Advancing in ${data.delaySeconds} seconds...`
            };
            
            if (completionTexts[data.phase]) {
                gmTimerDetails.textContent = completionTexts[data.phase];
            }
        });

        function updatePlayerList(players) {
            if (players.length === 0) {
                playerListDiv.innerHTML = '<p class="loading">No players yet...</p>';
                return;
            }

            playerListDiv.innerHTML = players.map(player => `
                <div class="player">
                    <strong>${player.nickname}</strong><br>
                    <small>Score: ${player.score}</small>
                </div>
            `).join('');
        }

        function updateGamePhase(gameState, data) {

            // Reset timer when phase changes
            if (gameState !== gmTimerState.phase) {
                resetGMTimer();
            }
            
            // Initialize timer display for timed phases
            if (data.timerRemaining && data.timerRemaining > 0) {
                const phase = gameState === 'submitting' ? 'submission' : 
                            gameState === 'voting' ? 'voting' : '';
                if (phase) {
                    updateGMTimer(data.timerRemaining, phase);
                }
            }

            // Hide all sections first
            [categorySection, submissionSection, votingSection, resultsSection].forEach(section => {
                section.classList.add('hidden');
            });



            switch(gameState) {
                case 'waiting-for-category':
                    currentPhaseDisplay.textContent = 'Set category for round ' + (data.round || 1);
                    categorySection.classList.remove('hidden');
                    roundNumber.textContent = data.round || 1;
                    displayPreview.textContent = 'Display shows: Waiting for category';
                    resetGMTimer(); // No timer during category setup
                    break;
                    
                case 'submitting':
                    currentPhaseDisplay.textContent = 'Players submitting exemplars';
                    submissionSection.classList.remove('hidden');
                    currentCategory.textContent = data.currentCategory;
                    updateSubmissionStatus(data.players);
                    displayPreview.textContent = `Display shows: Submit exemplars for "${data.currentCategory}"`;
                    break;
                    
                case 'voting':
                    currentPhaseDisplay.textContent = 'Players voting on exemplars';
                    votingSection.classList.remove('hidden');
                    updateVotingStatus(data.players);
                    displayPreview.textContent = 'Display shows: Vote on all exemplars';
                    break;
                    
                case 'results':
                    currentPhaseDisplay.textContent = 'Auto-displaying results...';
                    resultsSection.classList.remove('hidden');
                    // Hide manual navigation since it's now automatic
                    displayPreview.textContent = 'Display shows: Automated results sequence';
                    resetGMTimer(); // Results are auto-timed internally
                    break;
            }
        }

        function updateSubmissionStatus(players) {
            const submitted = players.filter(p => p.hasSubmitted).length;
            const total = players.length;
            
            if (submitted === total && total > 0) {
                showGMEarlyCompletion();
            }
            
            const statusHtml = players.map(player => {
                const hasSubmitted = player.hasSubmitted ? 'submitted' : 'waiting';
                const statusText = player.hasSubmitted ? 'Submitted' : 'Waiting...';
                return `
                    <div class="player-vote-status ${hasSubmitted}">
                        ${player.nickname}<br>
                        <small>${statusText}</small>
                    </div>
                `;
            }).join('');
            submissionStatus.innerHTML = statusHtml;
        }

        // Update voting status to show completion counts
        function updateVotingStatus(players) {
            const voted = players.filter(p => p.hasVoted).length;
            const total = players.length;
            
            if (voted === total && total > 0) {
                showGMEarlyCompletion();
            }
            
            const statusHtml = players.map(player => {
                const hasVoted = player.hasVoted ? 'submitted' : 'waiting';
                const statusText = player.hasVoted ? 'Voted' : 'Voting...';
                return `
                    <div class="player-vote-status ${hasVoted}">
                        ${player.nickname}<br>
                        <small>${statusText}</small>
                    </div>
                `;
            }).join('');
            votingStatus.innerHTML = statusHtml;
        }

        // Handle connection errors
        socket.on('connect_error', () => {
            alert('Connection error. Please refresh the page.');
        });
    </script>
</body>
</html>